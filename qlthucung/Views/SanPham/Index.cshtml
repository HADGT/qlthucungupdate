@model qlthucung.Models.HomeVm
@{
    ViewData["Title"] = "Trang chủ";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .text-brown {
        color: #8B5E3C;
    }

    #categoryMenu .nav-link {
        color: #5A3E2B;
        border-radius: 8px;
        padding: 8px 12px;
        transition: all 0.2s;
    }

        #categoryMenu .nav-link:hover {
            background-color: #e6d5c3;
            color: #8B5E3C;
            font-weight: bold;
            cursor: pointer;
        }

        #categoryMenu .nav-link.active {
            background-color: #d2b89c;
            color: #fff;
            font-weight: bold;
        }

    #categoryMenu .nav-item ul li span {
        font-style: italic;
        color: #a67c52;
    }

    /* Icon và text căn giữa */
    #categoryMenu .nav-link span {
        font-size: 1.1em;
    }

    /* Thêm shadow nhẹ xung quanh menu */
    .menu-sp-index {
        box-shadow: 0 4px 12px rgba(139,94,60,0.15);
    }
</style>

<div class="post-slider">

    <div class="post-wrapper">
        <div class="post">
            <img src="~/Content/images/BG-1.jpg" alt="">
        </div>
        <div class="post">
            <img src="~/Content/images/BG-2.jpg" alt="">
        </div>
        <div class="post">
            <img src="~/Content/images/BG-3.jpg" alt="">
        </div>
    </div>

</div>

<div class="container pt-5">
    <!-- Flash Sale -->
    <div class="mb-5">
        <div class="d-flex justify-content-between mb-3">
            <h2 class="fw-bold mb-3 pb-4">Flash Sale</h2>
        </div>
        <div class="row g-3">
            @if (Model?.SanPhamNoiBat != null)
            {
                @foreach (var item in Model.SanPhamNoiBat)
                {
                    <div class="custom-col">
                        <a asp-controller="SanPham" asp-action="Details" asp-route-id="@item.Masp">
                            <div class="card h-100 shadow-sm border-0">
                                <div class="position-relative">
                                    <div class="product__img">
                                        <img src="@item.Hinh" class="card-img-top" />
                                    </div>
                                    <span class="badge bg-danger position-absolute top-0 end-0 m-2">
                                        @(item.Giamgia > 0 ? item.Giamgia + "%" : "Mới")
                                    </span>
                                </div>
                                <div class="product__content">
                                    <div class="product__title">@item.Tensp</div>
                                    @if (item.Giamgia > 0)
                                    {
                                        <small class="text-muted"><s>@string.Format("{0:N0}", item.Giaban) ₫</s></small>
                                    }
                                    <div class="fw-bold text-danger">@string.Format("{0:N0}", item.Giakhuyenmai) ₫</div>
                                </div>
                            </div>
                        </a>
                    </div>
                }
            }
        </div>
    </div>

    <!-- Kẻ ngang giữa Flash Sale và Sản phẩm -->
    <hr class="my-5" />

    <div class="banner pb-4">
        <div class="pb-5 text-center">
            <h2 class="fw-bold">Dịch vụ của chúng tôi</h2>
        </div>

        <div class="banner-top banner-top-2 row g-4">
            <div class="col-md-3 col-sm-6">
                <a href="@Url.Action("Index", "SanPham")" class="banner-top-2-child bg-green">
                    <div>Mua sắm thú cưng, sản phẩm phụ kiện,...</div>
                </a>
            </div>

            <div class="col-md-3 col-sm-6">
                <a href="@Url.Action("Index", "DichVu")" class="banner-top-2-child bg-blue">
                    <div>Đặt lịch Spa cho thú cưng</div>
                </a>
            </div>

            <div class="col-md-3 col-sm-6">
                <a href="@Url.Action("UserIndex", "AdminChat")" class="banner-top-2-child bg-orange">
                    <div>Liên hệ, tư vấn trực tiếp</div>
                </a>
            </div>

            <div class="col-md-3 col-sm-6">
                <a href="#" class="banner-top-2-child bg-red">
                    <div>Giải đáp kiến thức cần thiết</div>
                </a>
            </div>
        </div>
    </div>

    <!-- Kẻ ngang giữa Flash Sale và Sản phẩm -->
    <hr class="my-5" />

    <!-- Menu + Sản phẩm -->
    <div class="row">
        <!-- Menu bên trái -->
        <!-- Menu -->
        <div class="menu-sp-index col-md-3 border-end pe-4" style="min-height: 400px; background: #f5f0eb; border-radius: 12px; padding: 20px;">
            <!-- Hình minh họa nhỏ ở góc -->
            <img src="~/Content/images/paw-pattern.png" style="position: absolute; bottom: 10px; right: 10px; width: 50px; opacity: 0.2;" alt="decor">
            <h2 class="fw-bold mb-3 pb-3 text-brown">Danh mục</h2>
            <ul class="nav flex-column" id="categoryMenu">
                <li class="nav-item mb-2">
                    <a href="#" class="nav-link active fw-bold d-flex align-items-center" data-type="l1" data-id="all">
                        <span class="me-2">🏠</span> Tất cả
                    </a>
                </li>
                @foreach (var cat in Model.RootCategoriesl1)
                {
                    <li class="nav-item">
                        <a href="#" class="nav-link d-flex align-items-center mb-2 mt-2" data-type="l1" data-id="@cat.Id"> @cat.Ten</a>
                        <!-- Vùng để render L2 -->
                        <ul class="nav flex-column ps-4 d-none" id="l2-of-@cat.Id">
                            <li class="nav-item text-muted small mb-2">
                                <span>Chọn danh mục con...</span>
                            </li>
                        </ul>
                    </li>
                }
            </ul>
        </div>

        <!-- Sản phẩm bên phải -->
        <div class="col-md-9 ps-4">
            <h2 class="fw-bold mb-3 pb-4">Sản phẩm</h2>
            <div id="productTabContent">
                <div class="row g-3">
                    @{
                        int maxShow = 12; // Số sản phẩm hiển thị ban đầu
                        int total = Model.AllProducts.Count();
                        var showProducts = Model.AllProducts.Take(maxShow);
                    }
                    @foreach (var item in showProducts)
                    {
                        <div class="col-12 col-sm-6 col-md-4">
                            <a asp-controller="SanPham" asp-action="Details" asp-route-id="@item.Masp">
                                <div class="card h-100 shadow-sm border-0">
                                    <div class="position-relative">
                                        <div class="product__img">
                                            <img src="@item.Hinh" class="img-fluid rounded-top" />
                                        </div>
                                        <span class="badge bg-danger position-absolute top-0 end-0 m-2">
                                            @(item.Giamgia > 0 ? item.Giamgia + "%" : "Mới")
                                        </span>
                                    </div>
                                    <div class="product__content p-2">
                                        <div class="product__title fw-bold">@item.Tensp</div>
                                        @if (item.Giamgia > 0)
                                        {
                                            <small class="text-muted"><s>@string.Format("{0:N0}", item.Giaban) ₫</s></small>
                                        }
                                        <div class="fw-bold text-danger">@string.Format("{0:N0}", item.Giakhuyenmai) ₫</div>
                                    </div>
                                </div>
                            </a>
                        </div>
                    }
                </div>
                @if (total > maxShow)
                {
                    <div class="text-center mt-3">
                        <a asp-controller="SanPham" asp-action="TatCaSanPham" class="btn btn-sm btn-primary mt-2 w-100">Xem thêm</a>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Banner nhỏ -->
<div class="row g-3 mb-5 pt-5">
    <div class="col-md-4 col-12"><img src="~/Content/images/bg1.jpg" class="w-100 rounded" /></div>
    <div class="col-md-4 col-12"><img src="~/Content/images/bg2.jpg" class="w-100 rounded" /></div>
    <div class="col-md-4 col-12"><img src="~/Content/images/bnn.jpg" class="w-100 rounded" /></div>

</div>
@section Scripts {
    <script>
        async function initAllProducts() {
            // Lấy toàn bộ sản phẩm từ server
            const res = await fetch(`/SanPham/ViewAllSanPham`);
            const allProducts = await res.json();

            document.querySelectorAll('#categoryMenu .nav-link[data-type="l1"]').forEach(l1 => {
                l1.addEventListener('click', async e => {
                    e.preventDefault();

                    // reset active cho L1
                    document.querySelectorAll('#categoryMenu .nav-link[data-type="l1"]')
                        .forEach(t => t.classList.remove('active', 'fw-bold'));

                    // đánh dấu active cho L1
                    l1.classList.add('active', 'fw-bold');

                    const l1Id = l1.getAttribute('data-id');
                    const l2Container = document.getElementById(`l2-of-${l1Id}`);
                    const content = document.getElementById('productTabContent');

                    // Ẩn tất cả L2 khác
                    document.querySelectorAll('#categoryMenu ul[id^="l2-of-"]').forEach(u => u.classList.add('d-none'));

                    if (l1Id === "all") {
                        // Gọi renderProducts với toàn bộ sản phẩm
                        renderProducts(allProducts);
                        return;
                    }

                    // Gọi API lấy L2 + sản phẩm
                    const res = await fetch(`/SanPham/GetLevel2AndProducts?l1Id=${l1Id}`);
                    const data = await res.json();

                    // Hiện menu L2
                    l2Container.classList.remove('d-none');
                    l2Container.innerHTML = "";
                    data.level2.forEach(cat => {
                        l2Container.innerHTML += `
                                            <li class="nav-item">
                                                <a href="#" class="nav-link" data-type="l2" data-id="${cat.id}" data-parent="${l1Id}">
                                                    ${cat.ten}
                                                </a>
                                            </li>`;
                    });

                    // Chọn L2 đầu tiên nếu có
                    let defaultL2Id = data.level2.length > 0 ? data.level2[0].id : null;

                    // Render sản phẩm mặc định theo L2 đầu tiên hoặc tất cả L2
                    let defaultProducts = defaultL2Id ? data.products[defaultL2Id] : Object.values(data.products).flat();
                    renderProducts(defaultProducts, l1Id, defaultL2Id);

                    // Active L2 đầu tiên nếu có
                    if (defaultL2Id) {
                        const firstL2 = l2Container.querySelector(`.nav-link[data-id="${defaultL2Id}"]`);
                        if (firstL2) firstL2.classList.add('active', 'fw-bold');
                    }
                });
            });

            // Delegate click cho menu L2
            document.getElementById('categoryMenu').addEventListener('click', function (e) {
                if (e.target.matches('.nav-link[data-type="l2"]')) {
                    e.preventDefault();

                    // reset active cho tất cả L2
                    document.querySelectorAll('#categoryMenu .nav-link[data-type="l2"]')
                        .forEach(t => t.classList.remove('active', 'fw-bold'));

                    // active cho L2 được chọn
                    e.target.classList.add('active', 'fw-bold');

                    const l2Id = e.target.getAttribute('data-id');
                    const parentId = e.target.getAttribute('data-parent');

                    fetch(`/SanPham/GetProductsByLevel2?l2Id=${l2Id}&l1Id=${parentId}`)
                        .then(res => res.json())
                        .then(products => renderProducts(products, parentId, l2Id));
                }
            });
        }

        function renderProducts(products, l1Id = "all", l2Id = null) {
            const content = document.getElementById('productTabContent');
            const maxShow = 12; // số sản phẩm hiển thị tối đa
            if (!products || products.length === 0) {
                content.innerHTML = `
                    <div class="text-center py-5">
                        <h5 class="text-muted">❌ Không tìm thấy sản phẩm nào phù hợp.</h5>
                    </div>
                `;
                return;
            }
            let showProducts = products.slice(0, maxShow);

            content.innerHTML = `
                                <div class="row g-3">
                                    ${showProducts.map(sp => `
                                        <div class="col-12 col-sm-6 col-md-4">
                                            <a href="/SanPham/Details/${sp.masp}">
                                                <div class="card h-100 shadow-sm border-0">
                                                    <div class="position-relative">
                                                        <img src="${sp.hinh}" class="card-img-top" />
                                                        <span class="badge bg-danger position-absolute top-0 end-0 m-2">
                                                            ${sp.giamgia > 0 ? sp.giamgia + "%" : "Mới"}
                                                        </span>
                                                    </div>
                                                    <div class="card-body p-2">
                                                        <div>${sp.tensp}</div>
                                                        ${sp.giamgia > 0 ? `<small class="text-muted"><s>${sp.giaban.toLocaleString()} ₫</s></small>` : ""}
                                                        <div class="fw-bold text-danger">${sp.giakhuyenmai.toLocaleString()} ₫</div>
                                                    </div>
                                                </div>
                                            </a>
                                        </div>
                                    `).join("")}
                                </div>
                            `;

            if (products.length > maxShow) {
                const btn = document.createElement('a');
                btn.className = 'btn btn-sm btn-primary mt-2 w-100';
                btn.textContent = 'Xem thêm';
                btn.href = `/SanPham/TatCaSanPham?maLoai=${l2Id}`;
                content.appendChild(btn);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initAllProducts();
        });
    </script>
}